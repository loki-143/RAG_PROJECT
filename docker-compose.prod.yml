version: "3.9"

services:
  # ===========================================
  # RAG API Service (FastAPI + Uvicorn)
  # ===========================================
  rag_api:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: rag_api
    restart: always
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - RAG_API_KEY=${RAG_API_KEY}
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - MAX_WORKERS=8
      - UVICORN_WORKERS=4
      - RATE_LIMIT_REQUESTS=60
      - RATE_LIMIT_WINDOW=60
      - MAX_QUESTION_LENGTH=5000
      - MAX_REQUEST_SIZE_MB=10
      - ALLOWED_DOMAINS=github.com,gitlab.com,bitbucket.org
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}
      - ENABLE_DOCS=false
    volumes:
      - rag_indexes:/app/rag_agent/indexes
      - rag_histories:/app/rag_agent/histories
    expose:
      - "8000"
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 1G
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # Nginx Reverse Proxy with SSL
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: rag_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      rag_api:
        condition: service_healthy
    networks:
      - rag_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================
  # Redis for Rate Limiting (Optional - for scaling)
  # ===========================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: rag_redis
  #   restart: always
  #   command: redis-server --appendonly yes
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - rag_network
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# ===========================================
# Networks
# ===========================================
networks:
  rag_network:
    driver: bridge

# ===========================================
# Volumes (persistent storage)
# ===========================================
volumes:
  rag_indexes:
    driver: local
  rag_histories:
    driver: local
  # redis_data:
  #   driver: local
